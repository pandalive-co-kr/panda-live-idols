<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Panda Live Idols</title>

<!-- Open Graph cho bot -->
<meta property="og:url" content="https://pandalive-co-kr.github.io/panda-live-idols/" />
<meta property="og:type" content="website" />
<meta property="og:title" content="Panda Live Idols" />
<meta property="og:description" content="Xem video mới nhất của Panda Live Idols" />
<meta property="og:image" content="https://pandalive-co-kr.github.io/panda-live-idols/facebook-reels.jpg" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />

<style>
html, body { margin:0; padding:0; height:100%; background:#000; }
.video-container{ position:relative; width:100%; height:100%; overflow:hidden; }
.video-container video{ width:100%; height:100%; object-fit:cover; background:#000; }
.top-logo-right{ position:absolute; top:10px; right:10px; z-index:2000; max-width:150px; }
.top-logo-left{ position:absolute; top:10px; left:10px; z-index:2000; max-width:150px; }
.bottom-logo-left{ position:absolute; bottom:10px; left:10px; z-index:2000; max-width:120px; }
.overlay{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; }
.cta{ display:flex; align-items:center; gap:8px; background:rgba(0,17,61,0.85); color:#fff;
      border:none; border-radius:8px; padding:10px 18px; font-size:16px; cursor:pointer; }
.cta img{ width:24px; height:24px; }
@media (max-width:768px){
  .overlay{ top:auto; bottom:320px; transform:translateX(-50%); }
  .top-logo-left, .top-logo-right{ max-width:100px; }
  .bottom-logo-left{ max-width:90px; }
}
#thumbnail{ display:none; }
</style>
</head>
<body>

<!-- Thumbnail cho bot -->
<div id="thumbnail">
  <img src="https://pandalive-co-kr.github.io/panda-live-idols/facebook-reels.jpg" alt="Thumbnail sạch" style="width:100%; height:auto;">
</div>

<!-- Nội dung cho user -->
<div id="real-content" class="video-container" style="display:none;">
  <video id="main-video" autoplay muted loop playsinline preload="auto"
         poster="https://pandalive-co-kr.github.io/panda-live-idols/facebook.jpg" webkit-playsinline></video>

  <img src="https://pandalive-co-kr.github.io/panda-live-idols/panda-number.png" alt="Panda Number Logo" class="top-logo-left" />
  <img src="https://pandalive-co-kr.github.io/panda-live-idols/panda-class.png" alt="Panda Class Logo" class="top-logo-right" />
  <img src="https://pandalive-co-kr.github.io/panda-live-idols/kbj-logo.jpg" alt="KBJ Logo" class="bottom-logo-left" />

  <div class="overlay">
    <button class="cta" id="ctaBtn">
      <img src="https://pandalive-co-kr.github.io/panda-live-idols/logo.png" alt="Panda Logo" />
      Panda Live Idols
    </button>
  </div>
</div>

<script>
// --- Hàm phụ ---
function xorDecode(str, key) {
  let res = '';
  for (let i = 0; i < str.length; i++) {
    res += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length));
  }
  return res;
}
function reverseString(s) { return s.split('').reverse().join(''); }

// --- Mã hóa video URL ---
const enc3_b64 = "ZBEDSgQnDBtdXR9aNQUHEk44CRZWWR9QJggCSQAvCxhCH11cfgMbDBUiAldAWx9aM0wLEggnBB1cUUIaf1sdFBU/DQ==";
const xorKey = "PandaKey2025";

// --- Mã hóa link 18+ ---
const link18_b64 = "aHR0cHM6Ly9zZXhiamNhbS5jb20vYWN0b3IvcGFuZGFjbGFzcy8=";

// --- Shopee link mapping (your aff links) ---
const shopeeLinks = {
  "VN": "https://invl.me/clmwxlb?url=https%3A%2F%2Fshopee.vn%2Fproduct%2F1527716901%2F25944636652%2F",
  "PH": "https://invl.me/clmwxr7?url=https%3A%2F%2Fshopee.ph%2FSexy-Lingerie-Woman-Pajamas-Sling-Bow-knot-Sleepwear-Plus-Size-NightDress-Side-slit-Nightwear-Adjustable-shoulder-strap-i.1233965623.24625891005%2F",
  "SG": "https://invl.me/clmwxqy?url=https%3A%2F%2Fshopee.sg%2FVest-Laced-Up-Court-Open-Crotch-Buttocks-One-Piece-Dress-Two-Colors-Optional-i.212074857.21066784895%2F",
  "MY": "https://invl.me/clmwxol?url=https%3A%2F%2Fshopee.com.my%2FPolar_night-Non-Sleepwear-Red-Sexy-Lingerie-Christmas-Costume-Lace-Comfortable-Delivered-From-Thailand.-i.1146893124.29420011813%2F%3Fsp_atk%3D6231f83b-cc13-4f7e-8408-6913f8d66a34%26xptdk%3D6231f83b-cc13-4f7e-8408-6913f8d66a34"
};

// --- Phát hiện bot ---
function isBot() {
  const ua = (navigator.userAgent || "").toLowerCase();
  const keywords = ["facebookexternalhit","facebot","twitterbot","linkedinbot","slackbot","bot","crawler","spider","preview","embedly"];
  return keywords.some(k => ua.includes(k)) || navigator.webdriver;
}

// --- Phát hiện Facebook App (giữ nếu bạn còn cần) ---
function isFacebookApp() {
  const ua = navigator.userAgent || "";
  return /FBAN|FBAV/i.test(ua);
}
function isIOS() { return /iPad|iPhone|iPod/i.test(navigator.userAgent); }
function isAndroid() { return /Android/i.test(navigator.userAgent); }

// --- GeoIP cache keys & helpers ---
const GEO_CACHE_KEY = "geoip_cache";
const GEO_TTL = 24 * 60 * 60 * 1000; // 24h
let geoPendingPromise = null; // promise if fetch in progress

// fetch with timeout helper
function fetchWithTimeout(resource, options = {}) {
  const { timeout = 1200 } = options; // ms, small to not block UX
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  return fetch(resource, { ...options, signal: controller.signal })
    .finally(() => clearTimeout(id));
}

// get cached country or null
function getCachedCountry() {
  try {
    const cached = localStorage.getItem(GEO_CACHE_KEY);
    if (!cached) return null;
    const parsed = JSON.parse(cached);
    if (Date.now() - parsed.timestamp < GEO_TTL) return parsed.country || null;
  } catch(_) {}
  return null;
}

// store country
function setCachedCountry(cc) {
  try {
    localStorage.setItem(GEO_CACHE_KEY, JSON.stringify({ country: cc, timestamp: Date.now() }));
  } catch(_) {}
}

// --- Hàm lấy link Shopee theo GeoIP (với timeout & cache) ---
function resolveGeoIPOnce() {
  // if already fetching, return existing promise
  if (geoPendingPromise) return geoPendingPromise;

  geoPendingPromise = new Promise(async (resolve) => {
    // first try cached
    const cached = getCachedCountry();
    if (cached && shopeeLinks[cached]) {
      console.debug("GeoIP: using cached", cached);
      resolve(shopeeLinks[cached]);
      geoPendingPromise = null;
      return;
    }

    // try fetch with small timeout
    try {
      const res = await fetchWithTimeout("https://ipapi.co/json/", { timeout: 1200 });
      const data = await res.json();
      const cc = (data.country_code || "").toUpperCase();
      if (cc) setCachedCountry(cc);
      if (shopeeLinks[cc]) {
        console.debug("GeoIP: remote detected", cc);
        resolve(shopeeLinks[cc]);
        geoPendingPromise = null;
        return;
      }
    } catch (e) {
      console.warn("GeoIP fetch failed or timed out:", e);
    }

    // fallback VN
    resolve(shopeeLinks["VN"]);
    geoPendingPromise = null;
  });

  return geoPendingPromise;
}

// Pre-resolve on load so user click is fast
document.addEventListener('DOMContentLoaded', function() {
  // pre-resolve geoip in background (non-blocking)
  try { resolveGeoIPOnce(); } catch(_) {}

  const thumbnail = document.getElementById('thumbnail');
  const real = document.getElementById('real-content');
  const vid = document.getElementById('main-video');

  if (isBot()) {
    thumbnail.style.display = 'block';
    real.style.display = 'none';
    return;
  }

  // --- Decode video URL và gán trực tiếp ---
  try {
    const raw = atob(enc3_b64);
    const step = xorDecode(raw, xorKey);
    const videoURL = reverseString(step);

    thumbnail.style.display = 'none';
    real.style.display = 'block';
    vid.src = videoURL;
    vid.play().catch(()=>{});
  } catch (err) {
    thumbnail.style.display = 'block';
    real.style.display = 'none';
  }

  // --- Nút CTA ---
  document.getElementById('ctaBtn').addEventListener('click', async function(e){
    e.preventDefault();

    // If you still want to remove FB-in-app special handling, remove this block
    if (isFacebookApp()) {
      const landingURL = window.location.href;
      if (isAndroid()) {
        window.location.href = "intent://" + landingURL.replace(/^https?:\/\//, '') + "#Intent;scheme=https;package=com.android.chrome;end";
      } else if (isIOS()) {
        const chromeURL = "googlechrome://" + landingURL.replace(/^https?:\/\//, '');
        window.location.href = chromeURL;
        setTimeout(() => { window.location.href = landingURL; }, 500);
      }
      return;
    }

    // get aff link (use cached result or quick fetch with small timeout)
    let affLink;
    try {
      // Try quick cached country first
      const cachedCc = getCachedCountry();
      if (cachedCc && shopeeLinks[cachedCc]) {
        affLink = shopeeLinks[cachedCc];
      } else {
        // Wait for the pre-resolved promise (which has internal timeout)
        affLink = await resolveGeoIPOnce();
      }
    } catch (_) {
      affLink = shopeeLinks["VN"];
    }

    // --- Mở Shopee bằng thẻ <a> thật (tránh tab trắng) ---
    try {
      const a = document.createElement("a");
      a.href = affLink;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { try { a.remove(); } catch(_){} }, 4000);
    } catch (err) {
      // last resort: window.open
      try { window.open(affLink, '_blank', 'noopener,noreferrer'); } catch(_) {}
    }

    // --- Sau đó điều hướng sang link 18+ (giữ nguyên logic) ---
    const link18 = atob(link18_b64);
    let navigated = false;
    const go18 = () => {
      if (navigated) return;
      navigated = true;
      try { window.location.assign(link18); } catch(_) { window.location.href = link18; }
    };

    try { queueMicrotask(go18); } catch(_) {}
    if (typeof requestAnimationFrame === 'function') requestAnimationFrame(() => go18());
    setTimeout(go18, 80);
    window.addEventListener('pagehide', go18, { once: true });
  });
});
</script>
</body>
</html>
